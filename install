#!/usr/bin/python
# -*- coding: utf-8 -*-
import os
import json
import shutil


HOME = os.path.expanduser("~")
HERE = os.path.dirname(os.path.abspath(__file__))


with open(os.path.join(HERE, "install.json"), mode="r", encoding="UTF-8") as f:
    install_config = json.load(f)


def install_programs() -> None:
    os.system(
        f'sudo pacman -S {" ".join(install_config["programs"])} '
        '--needed --noconfirm --overwrite "*"'
    )

    if shutil.which("yay") is None:
        yay_path = os.path.join(HERE, "yay")
        if os.path.exists(yay_path):
            os.system(f"rm -rfv {yay_path}")
        os.system(
            f"git clone https://aur.archlinux.org/yay.git {yay_path} "
            f"&& cd {yay_path} && makepkg -si && rm -rfv {yay_path}"
        )

    os.system(
        f'yay -S {" ".join(install_config["aur"])} '
        '--needed --noconfirm'
    )


def install_configs(symlink: bool = True) -> None:
    base_cmd = f'cp -rv --remove-destination {"--symbolic-link" if symlink else ""}'
    for src, dst in install_config["configs"].items():
        src_dir = os.path.join(HERE, "configs")
        dst_father = os.path.dirname(dst)
        if dst.startswith("/"):
            os.system(f"sudo mkdir -pv {dst_father}")
            os.system(f"sudo {base_cmd} {os.path.join(src_dir, src)} {dst}")
        else:
            if not os.path.isabs(dst):
                dst = os.path.join(HOME, dst)
            if not os.path.isabs(dst_father):
                dst_father = os.path.join(HOME, dst_father)
            os.system(f"mkdir -pv {dst_father}")
            os.system(f"{base_cmd} {os.path.join(src_dir, src)} {dst}")


def install_python_libs() -> None:
    os.system(f"pip install {' '.join(install_config['python'])}")


def extra_config() -> None:
    os.system("git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm")
    os.system("~/.tmux/plugins/tpm/scripts/install_plugins.sh")
    os.system("sudo grub-mkconfig -o /boot/grub/grub.cfg")


def main() -> None:
    install_programs()
    install_configs(symlink=False)
    install_python_libs()
    extra_config()


main()
